@model quizweb.ViewModels.QuestionSet.CreateQuestionSetViewModel
@{
    ViewData["Title"] = "Create Quiz";
}

<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="mb-4">Create a New Quiz</h1>

            <form id="createForm" asp-action="Create" method="post" novalidate>
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <!-- Quiz Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Quiz Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="QSetName" class="form-label fw-bold"></label>
                                <input asp-for="QSetName" class="form-control form-control-lg" placeholder="Enter the quiz title" />
                                <span asp-validation-for="QSetName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Description" class="form-label fw-bold"></label>
                                <input asp-for="Description" class="form-control" placeholder="Describe your quiz" />
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LevelId" class="form-label fw-bold"></label>
                                <select asp-for="LevelId" class="form-select">
                                    <option value="">-- Select Level --</option>
                                    @foreach (var level in Model.Levels)
                                    {
                                        <option value="@level.Value">@level.Text</option>
                                    }
                                </select>
                                <span asp-validation-for="LevelId" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryId" class="form-label fw-bold"></label>
                                <select asp-for="CategoryId" class="form-select">
                                    <option value="">-- Select Category --</option>
                                    @foreach (var cate in Model.Categories)
                                    {
                                        <option value="@cate.Value">@cate.Text</option>
                                    }
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Card -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Questions</h5>
                        <button type="button" class="btn btn-sm btn-success" onclick="addQuestion()">
                            <i class="fas fa-plus me-1"></i> Add Question
                        </button>
                    </div>
                    <div class="card-body" id="questionsContainer">
                        <!-- Questions will be dynamically added here -->
                        <p class="text-muted text-center" id="no-questions-placeholder">No questions added yet. Click 'Add Question' to start.</p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-4 text-end">
                    <a href="/" class="btn btn-secondary me-2">Cancel</a>
                    <input type="submit" value="Create Quiz" class="btn btn-primary btn-lg" />
                </div>
            </form>
        </div>
    </div>
</div>


<!-- TEMPLATES (Hidden from view) -->
<template id="questionTemplate">
    <div class="question-item card mb-3 border-primary" data-question-index="">
        <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
            <span class="fw-bold text-primary">Question <span class="question-number"></span></span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
                <i class="fas fa-trash-alt"></i> Remove
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Question Text</label>
                <input type="text" name="Questions[QINDEX].QuestionText" class="form-control" required placeholder="What is the question?" />
            </div>

            <div>
                <label class="form-label">Answers</label>
                <div class="answer-items">
                    <!-- Answers will be dynamically added here -->
                </div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addAnswer(this)">
                    <i class="fas fa-plus me-1"></i> Add Answer
                </button>
            </div>
        </div>
    </div>
</template>

<template id="answerTemplate">
    <div class="input-group mb-2 answer-item">
        <div class="input-group-text">
            <input type="checkbox" name="Questions[QINDEX].Answers[AINDEX].IsCorrect" value="true" class="form-check-input mt-0 is-correct-checkbox" title="Mark as correct answer" />
        </div>
        <input type="text" name="Questions[QINDEX].Answers[AINDEX].AnswerText" class="form-control" placeholder="Enter answer text" required />
        <button type="button" class="btn btn-outline-danger" onclick="removeAnswer(this)" title="Remove answer">&times;</button>
    </div>
</template>

@section Scripts {
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> <!-- Optional: For icons -->
    <script>

        let questionIndex = 0;

        function addQuestion(){
            const template = document.getElementById('questionTemplate');
            const clone = template.content.cloneNode(true);

            const questionDiv = clone.querySelector('.question-item');
            questionDiv.setAttribute('data-question-index', questionIndex);
            questionDiv.querySelector('.question-number').textContent = questionIndex + 1;

            const inputs = clone.querySelectorAll('[name*="QINDEX"]');
            inputs.forEach(input => {
                input.name = input.name.replace('QINDEX', questionIndex);
            });

            const answerContainer = clone.querySelector('.answer-items');
            for(let i = 0; i < 2; i++){
                const answerHtml = createAnswer(questionIndex, i);
                answerContainer.insertAdjacentHTML('beforeend', answerHtml);
            }

            document.getElementById('questionsContainer').appendChild(clone);
            questionIndex++;
        }


        function createAnswer(qIndex, aIndex){
            const template = document.getElementById('answerTemplate');
            const clone = template.content.cloneNode(true);
            const div = document.createElement('div');
            div.appendChild(clone);

            let html = div.innerHTML;
            html = html.replace(/QINDEX/g, qIndex);
            html = html.replace(/AINDEX/g, aIndex);

            return html;
        }


        function addAnswer(button){
            const questionDiv = button.closest('.question-item');
            const qIndex = questionDiv.getAttribute('data-question-index');
            const answerItems = questionDiv.querySelector('.answer-items')
            const currentAnswerCount = answerItems.querySelectorAll('.answer-item').length;

            const answerHtml = createAnswer(qIndex, currentAnswerCount);
            answerItems.insertAdjacentHTML('beforeend', answerHtml);
        }

        function removeQuestion(button){
            button.closest('.question-item').remove();
            updateQuestionNumbers();
        }

        function removeAnswer(button){
            const answerItem = button.closest('.answer-items');
            if (answerItem.querySelectorAll('.answer-item').length >2){
                button.closest('.answer-item').remove();
            }else{
                alert('A question must have at least 2 answers!');
            }
        }


        function updateQuestionNumbers(){
            document.querySelectorAll('.question-item').forEach((item, index) => {
                item.querySelector('question-number').textContent = index + 1;
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            addQuestion();
        });

        document.getElementById('createForm').addEventListener('submit', function(e) {
            const checkbox = document.querySelectorAll('.is-correct-checkbox').forEach(checkbox =>{
                const container = checkbox.closest('.input-group');

                const answerText = container.querySelector('input[name*="AnswerText"]');
                const name = answerText.name;

                const match = name.match(/Questions\[(\d+)\]\.Answers\[(\d+)\]/);
                if(match){
                    const qIndex = match[1];
                    const aIndex = match[2];

                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `Questions[${qIndex}].Answers[${aIndex}].IsCorrect`;
                    hiddenInput.value = checkbox.checked ? 'true' : 'false';

                    container.appendChild(hiddenInput);
                }

            });
        });

        // UX
        function updateQuestionNumbers() {
            const questionItems = document.querySelectorAll('#questionsContainer .question-item');
            const placeholder = document.getElementById('no-questions-placeholder');
            if (questionItems.length === 0) {
                if(placeholder) placeholder.style.display = 'block';
            } else {
                 if(placeholder) placeholder.style.display = 'none';
            }
            questionItems.forEach((item, index) => {
                item.querySelector('.question-number').textContent = index + 1;
            });
        }

    </script>
}