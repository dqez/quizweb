@model quizweb.ViewModels.QuestionSet.PlayQuestionSetViewModel;
@{
    ViewBag.Title = "Play Quiz";
}

<h2>Play Quiz: @Model.QSetName</h2>
<h3>Description: @Model.Description</h3>
<h3>Level: @Model.LevelName</h3>
<h3>Category: @Model.CategoryName</h3>
<h3>By: @Model.AuthorName</h3>

<form asp-action="Play" method="post" id="quizForm" data-save-url="@Url.Action("SaveProgress", "Quiz")">

    <input type="hidden" name="QSetId" value="@Model.QSetId" />
    <input type="hidden" name="QSetName" value="@Model.QSetName" />
    <input type="hidden" id="QuestionCount" name="QuestionCount" value=0/>
    <input type="hidden" id="QuestionLastId" name="QuestionLastId" value=0/>

    @for (int i = 0; i < Model.Questions.Count; i++)
    {
        var q = Model.Questions[i];

        <div class="question-container" data-question-id="@q.QuestionId">
            <input type="hidden" name="UserAnswers[@i].QuestionId" value="@q.QuestionId" />
            <input type="checkbox" class="save-question-checkbox" id="save-@q.QuestionId" data-question-id="@q.QuestionId"/>

            <div class="QuestionText">Question: @q.QuestionText</div>
            <div class="Options">

                @for (int j = 0; j < q.Answers.Count; j++)
                {
                    var a = q.Answers[j];
                    var inputId = $"question_{q.QuestionId}_answer_{a.AnswerId}";


                    <div>
                        <input type="radio" id="@inputId" name="UserAnswers[@i].SelectedAnswerId" value="@a.AnswerId" class="answer-radio" required />
                        <label asp-for="@a.AnswerText">
                            @a.AnswerText
                        </label>
                        <br />
                    </div>
                }
            </div>
        </div>
    }

    <div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
        <a asp-action="Index" class="btn btn-secondary cancel-link" id="cancelBtn" data-confirm="true">Cancel</a>
    </div>

</form>

@section Scripts {
    <script>

        (function() {
            const form = document.getElementById('quizForm');
            const saveUrl = form.dataset.saveUrl; // SaveProgress endpoint
            let dirty = false;

            const questionLastId = document.getElementById('QuestionLastId');
            const questionCount = document.getElementById('QuestionCount');


            function updateLastAnsweredQuestion() {
                questionLastId.value = getLastAnsweredQuestionId();
                questionCount.value = getAnsweredQuestionCount();
            }


            // 1) Mark dirty when any answer selected
            document.querySelectorAll('.answer-radio').forEach(radio => {
                radio.addEventListener('change',
                    (ev) => {
                        dirty = true;

                        document.querySelectorAll('.last-question').forEach(e => {
                            e.classList.remove('last-question');
                        });

                        const questionContainer = ev.target.closest('.question-container');
                        if (questionContainer) {
                            questionContainer.classList.add('last-question');
                            questionContainer.classList.add('answered');
                        }
                    });
            });

            function getAnsweredQuestionCount() {
                return document.querySelectorAll('.question-container.answered').length;
            }

            function getLastAnsweredQuestionId() {
                const lastQuestionDiv = document.querySelector('.last-question');
                return lastQuestionDiv ? lastQuestionDiv.dataset.questionId : '0';
            }

            // 2) On standard submit, clear dirty (server will handle final submission)
            form.addEventListener('submit',
                () => {
                    dirty = false;
                    updateLastAnsweredQuestion();
                    // allow normal submit
                });

            // 3) beforeunload native prompt
            this.window.addEventListener('beforeunload',
                function(e) {
                    if (!dirty) return;
                    // Standard message not customizable in modern browsers
                    const confirmationMessage = 'You have unsaved progress. Do you really want to leave?';
                    (e || this.window.event).returnValue = confirmationMessage;
                    return confirmationMessage;
                });

            // Helper: gather current form data into FormData
            function gatherFormData() {
                const fd = new FormData();

                fd.set('QSetId', '@Model.QSetId');
                fd.set('QuestionCount', getAnsweredQuestionCount().toString());

                const lastQuestionId = getLastAnsweredQuestionId();
                fd.set('QuestionLastId', lastQuestionId === '0' ? '0' : lastQuestionId);

                const questionContainers = document.querySelectorAll('.question-container');
                let answerIndex = 0;

                questionContainers.forEach(container => {
                    const questionId = container.dataset.questionId;
                    const selectedRadio = container.querySelector('.answer-radio:checked');

                    if (selectedRadio) {
                        fd.append(`UserAnswers[${answerIndex}].QuestionId`, questionId);
                        fd.append(`UserAnswers[${answerIndex}].SelectedAnswerId`, selectedRadio.value);
                    }
                    answerIndex++;

                });


                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput && !fd.has('__RequestVerificationToken')) {
                    fd.append('__RequestVerificationToken', tokenInput.value);
                }

                return fd;
            }


            // 4) save progress via AJAX POST
            function saveProgress() {
                const fd = gatherFormData();

                return fetch(saveUrl,
                    {
                        method: 'POST',
                        body: fd,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest' // indicates AJAX
                        },
                        credentials: 'same-origin'
                    }).then(response => {
                    if (!response.ok) throw new Error('Save failed: ' + response.status);
                    return response;
                });
            }

            // 5) Confirm + navigation helper
            function confirmAndNavigate(targetUrl) {
                if (!dirty) {
                    window.location.href = targetUrl;
                    return;
                }

                const shouldSave = confirm('You have unsaved progress. Save progress before leaving? Click OK to save, Cancel to leave without saving.');
                if (shouldSave) {
                    // optionally show a simple saving indicator
                    const originalText = document.activeElement && document.activeElement.innerText;
                    // perform save
                    saveProgress()
                        .then(() => {
                            dirty = false;
                            window.location.href = targetUrl;
                        })
                        .catch(err => {
                            // if save failed, ask user whether to still navigate
                            const navigateAnyway = confirm('Saving progress failed. Leave anyway?');
                            if (navigateAnyway) {
                                dirty = false;
                                window.location.href = targetUrl;
                            }
                        });
                } else {
                    // user chose not to save
                    dirty = false;
                    window.location.href = targetUrl;
                }
            }

            // 7) Intercept navbar links (common pattern) - add data-confirm="true" to links you want protected
            // Protect links that have class 'nav-link' or attribute data-confirm="true"
            document.querySelectorAll('a.nav-link, a[data-confirm="true"]').forEach(a => {
                // skip links that target same page anchors or javascript:void
                if (!a.href || a.getAttribute('href').startsWith('#') || a.getAttribute('href').startsWith('javascript:')) return;

                a.addEventListener('click',
                    function(ev) {
                        // if link points to current origin and is a different page, intercept
                        const linkUrl = a.href;
                        const samePage = (linkUrl.split('#')[0] === window.location.href.split('#')[0]);
                        if (samePage) return; // allow anchors on same page
                        ev.preventDefault();
                        confirmAndNavigate(linkUrl);
                    });
            });


            








        })();
    </script>
}
